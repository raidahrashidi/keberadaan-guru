<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Keberadaan Guru & AkP</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="styles.css" rel="stylesheet"><!-- external CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- XLSX for Excel import -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" defer></script>

<!-- Chart.js (for compact dashboard) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

<!-- Bootstrap JS (for modal) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- Base64 logo (must load before app.js) -->
<script src="logo_dataurl_fixed.js" defer></script>

<script src="signature_dataurl.js" defer></script>


<!-- App logic -->
<script src="app.js" defer></script>
</head>
<body>
<header>
  <div class="container">
    <div class="header-center d-flex flex-column align-items-center text-center">
      <img id="schoolLogo" src="" alt="Logo Sekolah" class="header-logo mb-2">
      <h4 class="mb-0 fw-bold">Keberadaan Guru & AkP</h4>
      <small class="header-sub">Rekod mingguan ketidakhadiran</small>
    </div>
  </div>
</header>

<div class="container my-4">

  <!-- WEEK / DATE -->
  <div class="card p-4 mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Minggu</label>
        <select id="minggu" class="form-select"></select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Tarikh Semasa</label>
        <input id="tarikh" type="date" class="form-control">
      </div>
    </div>
  </div>

  <!-- FORM -->
  <div class="card p-4 mb-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-1">
      <h5 class="fw-semibold text-primary mb-0">Tambah Rekod Ketidakhadiran</h5>
      <div class="d-flex gap-2">
        <button id="btnUpdateData" type="button" class="btn btn-outline-primary">Update Data</button>
        <button id="btnClearCache" type="button" class="btn btn-outline-danger">Padam Cache</button>
      </div>
    </div>
    <div class="text-muted small mb-3" id="excelStatus">Tiada data dimuat naik.</div>
    <input id="excelInput" type="file" class="d-none" accept=".xlsx,.xls">

    <form id="rekodForm" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Jenis (Jawatan)</label>
        <select id="jenis" class="form-select" required>
          <option value="GURU">GURU</option>
          <option value="KONTRAK">KONTRAK</option>
          <option value="AKP">AKP</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Nama</label>
        <select id="nama" class="form-select" required>
          <option>— muat naik Excel dahulu —</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Sebab</label>
        <select id="sebab" class="form-select" required>
          <option value="Cuti Sakit">Cuti Sakit</option>
          <option value="Cuti Umrah">Cuti Umrah</option>
          <option value="Mesyuarat">Mesyuarat</option>
          <option value="Bengkel">Bengkel</option>
          <option value="Kursus">Kursus</option>
          <option value="Seminar">Seminar</option>
          <option value="Petugas Rasmi">Petugas Rasmi</option>
        </select>
      </div>
      <div class="col-12 text-end">
        <button class="btn btn-primary" type="submit">Tambah Rekod</button>
      </div>
    </form>
  </div>

  <!-- DAILY RECORDS BY DATE (Minggu terpilih) -->
  <div class="card p-4">
    <div class="section-title mb-2">
      <h5 class="fw-semibold text-primary mb-0" id="rekodTitle">Rekod Keberadaan (Minggu -)</h5>
    </div>
    <div id="rekodWrap"></div>
  </div>

  <!-- ======= TAPIS (Naik ke atas chart) ======= -->
  <div class="card p-4 mt-4">
    <div class="section-title mb-2">
      <h5 class="fw-semibold text-primary mb-0">Semua Rekod (Carian & Tapis)</h5>
      <span class="badge text-bg-secondary" id="allCount">0 rekod</span>
    </div>

    <!-- Filters -->
    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <label class="form-label mb-1">Cari Nama</label>
        <input id="allNama" type="text" class="form-control" placeholder="Taip nama…">
      </div>
      <div class="col-md-3">
        <label class="form-label mb-1">Jawatan</label>
        <select id="allJawatan" class="form-select">
          <option value="">Semua</option>
          <option value="GURU">GURU</option>
          <option value="KONTRAK">KONTRAK</option>
          <option value="AKP">AKP</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label mb-1">Minggu</label>
        <input id="allMinggu" type="number" min="1" max="53" class="form-control" placeholder="1–53">
      </div>
      <div class="col-md-3 d-flex gap-2">
        <div class="flex-fill">
          <label class="form-label mb-1">Tarikh Dari</label>
          <input id="allTarikhFrom" type="date" class="form-control" placeholder="dd/mm/yyyy">
        </div>
        <div class="flex-fill">
          <label class="form-label mb-1">Tarikh Hingga</label>
          <input id="allTarikhTo" type="date" class="form-control" placeholder="dd/mm/yyyy">
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end">
      <button id="allReset" class="btn btn-outline-secondary btn-sm">Reset Tapis</button>
    </div>
  </div>

  <!-- ======= SIMPLE DASHBOARD (ikut tapis di atas) ======= -->
  <div class="card p-4 mt-4">
    <div class="section-title mb-3">
      <h5 class="fw-semibold text-primary mb-0">Ringkasan</h5>
      <span class="badge text-bg-info" id="analitikRangeLabel">Semua tarikh</span>
    </div>

    <!-- KPI row -->
    <div class="row g-3 mb-2">
      <div class="col-6 col-lg-3">
        <div class="kpi-card">
          <div class="kpi-label">Jumlah Rekod</div>
          <div class="kpi-value" id="kpiTotal">0</div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="kpi-card">
          <div class="kpi-label">Unik Nama</div>
          <div class="kpi-value" id="kpiNama">0</div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="kpi-card kpi-muted">
          <div class="kpi-label">Julat Tarikh Tertapis</div>
          <div class="kpi-value kpi-value-sm" id="kpiRange">Semua tarikh</div>
        </div>
      </div>
    </div>

    <!-- Mini charts (fixed-height wrappers) -->
    <div class="mini-grid">
      <div class="mini-chart">
        <div class="mini-title">Sebab</div>
        <div class="chart-fixed"><canvas id="chartSebabMini"></canvas></div>
      </div>
      <div class="mini-chart">
        <div class="mini-title">Jawatan</div>
        <div class="chart-fixed"><canvas id="chartJawatanMini"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ======= JADUAL (Bawah chart, tanpa filter) ======= -->
  <div class="card p-4 mt-4">
    <div class="section-title mb-2">
      <h5 class="fw-semibold text-primary mb-0">Senarai Rekod</h5>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle kgas-table">
        <colgroup>
          <col style="width:7%">
          <col style="width:10%">
          <col style="width:18%">
          <col style="width:35%">
          <col style="width:12%">
          <col style="width:12%">
          <col style="width:6%">
        </colgroup>
        <thead>
          <tr>
            <th>Bil.</th>
            <th>Minggu</th>
            <th>Tarikh</th>
            <th>Nama</th>
            <th>Jawatan</th>
            <th>Sebab</th>
            <th class="text-end"></th>
          </tr>
        </thead>
        <tbody id="allTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== Floating Action Button: PDF ===== -->
<button id="fabPdf" class="btn btn-primary fab" aria-label="Jana PDF">
  <!-- Ikon download (SVG) -->
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
    <path d="M.5 9.9a.5.5 0 0 1 .5.5V13a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V10.4a.5.5 0 0 1 1 0V13a3 3 0 0 1-3 3H3a3 3 0 0 1-3-3V10.4a.5.5 0 0 1 .5-.5z"/>
    <path d="M7.646 10.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 1 0-.708-.708L8.5 9.293V1.5a.5.5 0 0 0-1 0v7.793L5.354 7.146a.5.5 0 1 0-.708.708z"/>
  </svg>
</button>

<!-- ===== Modal Pilihan PDF ===== -->
<div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title fw-semibold" id="pdfModalLabel">Jana Laporan PDF</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-semibold">Mod Pemilihan</label>
          <div class="list-group">
            <label class="list-group-item">
              <input class="form-check-input me-2" type="radio" name="pdfMode" value="week-range" checked>
              Julat Minggu (cth: 12 -> 15)
            </label>
            <label class="list-group-item">
              <input class="form-check-input me-2" type="radio" name="pdfMode" value="date-range">
              Julat Tarikh (cth: 2025-08-01 -> 2025-08-31)
            </label>
            <label class="list-group-item">
              <input class="form-check-input me-2" type="radio" name="pdfMode" value="weeks-exact">
              Minggu Tepat (senarai, cth: 12,14,21)
            </label>
          </div>
        </div>

        <!-- Week range -->
        <div id="pdfWeekRange" class="row g-2 mb-2">
          <div class="col">
            <label class="form-label mb-1">Minggu Dari</label>
            <input id="pdfWeekFrom" type="number" min="1" max="53" class="form-control" placeholder="1">
          </div>
          <div class="col">
            <label class="form-label mb-1">Minggu Hingga</label>
            <input id="pdfWeekTo" type="number" min="1" max="53" class="form-control" placeholder="53">
          </div>
        </div>

        <!-- Date range -->
        <div id="pdfDateRange" class="row g-2 mb-2 d-none">
          <div class="col">
            <label class="form-label mb-1">Tarikh Dari</label>
            <input id="pdfDateFrom" type="date" class="form-control">
          </div>
          <div class="col">
            <label class="form-label mb-1">Tarikh Hingga</label>
            <input id="pdfDateTo" type="date" class="form-control">
          </div>
        </div>

        <!-- Weeks exact -->
        <div id="pdfWeeksExact" class="mb-2 d-none">
          <label class="form-label mb-1">Minggu</label>
          <input id="pdfWeeksList" type="text" class="form-control" placeholder="cth: 12,14,21">
          <div class="form-text">Pisahkan dengan koma. Hanya nombor 1–53.</div>
        </div>

        <div class="small text-muted">Nota: Laporan akan menggabungkan rekod mengikut tarikh dalam julat yang dipilih.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
        <button type="button" id="btnGeneratePdf" class="btn btn-primary">Jana PDF</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
